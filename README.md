# Тестовое Задание YADRO

## Задача

Необходимо реализовать сервис и клиент для выставления имя хоста в Linux, а также изменение списка DNS серверов.

Сервис работает по протоколу gRPC, но также реализует и REST http API сгенерированный с помощью [grpc-gateway](https://github.com/grpc-ecosystem/grpc-gateway).

CLI Клиент использует фреймворк Cobra и может отправлять команды сервису (как через REST API, так и по grpc):

Реализуются следующие команды:
- Получить имя хоста
- Изменить имя хоста
- Получить список DNS серверов для дефлотного интерфейса
- Добавить DNS сервера в список дефолтного интерфейса
- Удалить DNS сервера из списка дефолтного интерфейса

## Quick Start

Makefile содержит необходимые скрипты

```sh
make server client
```

Компиляция производит два исполняемых файла: `client.out` и `server.out`.

## Использование

### Сервер

Для работы серверу необходимы права на редактирование `/etc/NetworkManager/NetworkManager.conf` (если не указаен флаг `--temp-dns`), а также на изменение dns списка через `resolvectl dns`, поэтому в примере используется `sudo`

```sh
# Запустить gRPC сервер на порте 1212 (по умолчанию 1234)
sudo ./server.out --grpc-port 1212

# Другие флаги:
# --rest-port  Порт на котором будет запущен REST http-gateway
# --grpc-logs  Выводит также логи самой библиотеки grpc
# --temp-dns   Сервер не пытается добавить `dns=none` в NetworkManager.conf (изменения DNS списков будут временные)
# --help       Больше информации о CLI
```

При запуске сервера вместе с REST gateway через флаг `--rest-port` на указанном порту будет запущен сервер с API сгенерированным через grpc-gateway.

- `localhost:xxxx/api/*` - API эндпоинты
- `localhost:xxxx/` - Swagger документация API 

### Клиент
```sh
./client.out --addr 0.0.0.0:1234 hostname                   # Получить имя хоста
./client.out --addr 0.0.0.0:1234 hostname set new-hotname   # Изменить имя хоста
./client.out --addr 0.0.0.0:1234 dns                        # Получить список DNS серверов
./client.out --addr 0.0.0.0:1234 dns add 1.1.1.1 8.8.8.8    # Добавить DNS сервера
./client.out --addr 0.0.0.0:1234 dns remove 1.1.1.1 8.8.8.8 # Удалить DNS сервера
# Другие флаги
# --rest     Клиент отправляет REST запросы вместо gRPC
# --timeout  Выставляет timeout на запросы (по умолчанию 1 секунда)
```

## Детали имплементации

Для изменения и получения имени хоста исполняется команда `hostnamectl`

Для изменения же DNS серверов процесс сложнее:
- `ip route show default` - получение дефолтного интерфейса на котором и нужно менять DNS сервера
- `resolvectl dns` - получение нынешних DNS серверов
- `resolvectl dns x.x.x.x y.y.y.y` - выставление новых DNS серверов

Также, для сохранения изменений DNS между перезагрузками, сервер при запуске изменяет файл `/etc/NetworkManager/NetworkManager.conf`, добавляя туда пару `dns=none`.